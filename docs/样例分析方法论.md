# 样例分析方法论

> 从优秀剧本样例中提取量化指标，作为 AI 剧本创作的硬约束。

## 1. 为什么用样例驱动约束

AI 生成剧本最大的问题是「形式走样」——对话太长、镜头提示太少、节奏失控。纯靠文字描述规则很难约束 LLM 的输出。

**核心思路**：把成熟剧本当标尺，从中统计关键数值指标（每集行数、台词比例、场景数等），将均值和合理区间作为生成约束注入 prompt。模型不需要"理解"什么是好剧本，只需在数值框内产出即可。

**优势**：
- 量化可校验：生成后可程序化检查是否达标
- 可持续迭代：接入更多样例，指标自动更新
- 跨题材适用：不同题材各有数值特征，换样例即换风格

## 2. 指标定义

每集提取 **6 个核心指标**：

| 指标 | 字段名 | 统计规则 |
|------|--------|----------|
| 场景数 | `scenes` | 匹配 `{集号}-{场号}` 格式的场次行数量 |
| 总行数 | `total_lines` | 该集所有非空行数（不含集标题行） |
| 台词行 | `dialogue_lines` | 包含全角冒号 `：` 且不属于其他类别的行 |
| 舞台指示行 | `stage_lines` | 以 `▲` 或 `【` 开头的行，加上含 `VO`/`OS` 的行 |
| VO/OS 行 | `vo_os_lines` | 以 `VO` 开头或含 `VO：`/`OS` 的行（是 stage_lines 的子集） |
| 人物行 | — | 以 `人物：` 开头，仅用于分隔，不计入统计 |

> 注意：`vo_os_lines` 同时被计入 `stage_lines`，所以 `台词行 + 舞台指示行 < 总行数`（差值为场次行和人物行）。

## 3. 提取流程

### 3.1 准备样例

将样例剧本 DOCX 放入 `scripts/` 目录。要求格式：
- 每集以 `第N集` 起始（中文数字或阿拉伯数字均可识别 `\d+`）
- 场次行格式：`{集号}-{场号}场 {场景名} {日/夜} {内/外}`
- 台词行用全角冒号分隔角色名和台词

### 3.2 单样例分析

```python
from juben_gen.style_profile import build_style_profile

profile = build_style_profile("scripts/末世天灾，我靠吞金超市躺赢.docx")
print(f"集数: {profile.episodes}")
print(f"集号范围: {profile.episode_range}")
print(f"平均场景数/集: {profile.avg_scenes_per_ep}")
print(f"平均总行数/集: {profile.avg_total_lines_per_ep}")
print(f"平均台词行/集: {profile.avg_dialogue_lines_per_ep}")
print(f"平均舞台指示行/集: {profile.avg_stage_lines_per_ep}")
print(f"平均VO/OS行/集: {profile.avg_vo_os_lines_per_ep}")
```

返回 `ScriptStyleProfile` 数据类，包含：
- 整体均值指标
- `per_episode` 列表：每一集的详细统计

### 3.3 多样例融合

```python
from juben_gen.style_profile import build_combined_profile, save_json

combined = build_combined_profile([
    "scripts/末世天灾，我靠吞金超市躺赢.docx",
    "scripts/地狱游戏：开局获得预知羊皮纸1216(1).docx",
])
save_json(combined, "juben_gen/style_profile.json")
```

### 3.4 CLI 方式（推荐）

```bash
python -m juben_gen profile
```

自动扫描 `scripts/` 下的 DOCX 文件，生成 `style_profile.json` 和 `STYLE_GUIDE.fused.md`。

## 4. 数据融合规则

当有多套样例时，融合策略如下：

### 4.1 数值指标

```
suggest = mean(各样例的该指标均值)
range   = 人工设定的合理区间
```

| 指标 | suggest 计算 | range 确定依据 |
|------|-------------|---------------|
| scenes_per_ep | 各样例 avg_scenes_per_ep 的均值 | [1, 3]：1-2分钟/集通常 1-3 个场景 |
| total_lines_per_ep | 各样例 avg_total_lines_per_ep 的均值 | [22, 38]：覆盖两套样例的主体分布 |
| dialogue_lines_per_ep | 各样例 avg_dialogue_lines_per_ep 的均值 | [10, 20]：短剧台词密度区间 |
| stage_lines_per_ep | 各样例 avg_stage_lines_per_ep 的均值 | [8, 20]：覆盖镜头提示需求 |
| vo_os_lines_per_ep | 各样例 avg_vo_os_lines_per_ep 的均值 | [0, 6]：VO/OS 可有可无 |

### 4.2 当前基线数据

基于两套样例（末世天灾 80 集 + 地狱游戏 24 集）：

| 指标 | 末世天灾 | 地狱游戏 | 融合 suggest |
|------|---------|---------|-------------|
| scenes_per_ep | 1.90 | 1.50 | 1.70 |
| total_lines_per_ep | 30.04 | 26.17 | 28.10 |
| dialogue_lines_per_ep | 13.03 | 7.54 | 10.28 |
| stage_lines_per_ep | 13.25 | 15.21 | 14.23 |
| vo_os_lines_per_ep | 2.64 | 6.04 | 4.34 |

**观察**：地狱游戏偏「重镜头轻对话」（stage_lines 高、dialogue 低），末世天灾更均衡。融合后指标兼顾两种风格。

### 4.3 range 的设定原则

`range` 不是从数据自动计算的，而是基于制作经验人工设定：
- 下限：确保内容不会太少导致「空集」
- 上限：确保单集不超过 1-2 分钟时长上限
- 随着接入更多样例，range 可以微调但不应频繁变动

## 5. 输出结构

融合后输出 `style_profile.json`，结构如下：

```json
{
  "sources": [
    {
      "file": "样例文件名.docx",
      "episodes": 80,
      "episode_range": [1, 80],
      "avg_scenes_per_ep": 1.9,
      "avg_total_lines_per_ep": 30.04,
      "avg_dialogue_lines_per_ep": 13.03,
      "avg_stage_lines_per_ep": 13.25,
      "avg_vo_os_lines_per_ep": 2.64,
      "per_episode": [
        {"episode": 1, "scenes": 2, "total_lines": 44, "dialogue_lines": 16, "stage_lines": 24, "vo_os_lines": 4},
        ...
      ]
    }
  ],
  "target": {
    "scenes_per_ep": {"suggest": 1.7, "range": [1, 3]},
    "total_lines_per_ep": {"suggest": 28.1, "range": [22, 38]},
    "dialogue_lines_per_ep": {"suggest": 10.28, "range": [10, 20]},
    "stage_lines_per_ep": {"suggest": 14.23, "range": [8, 20]},
    "vo_os_lines_per_ep": {"suggest": 4.34, "range": [0, 6]}
  }
}
```

**关键字段**：
- `sources`：保留每套样例的原始统计，可追溯
- `target`：融合后的约束参数，直接注入 prompt 使用
- `per_episode`：逐集明细，用于异常检测和深度分析

## 6. 行分类逻辑详解

代码位于 `juben_gen/style_profile.py` 的 `_episode_stats()` 函数，判断优先级从高到低：

```
1. 场次行     → 匹配正则 r"^\d+-\d+"       → scenes += 1，不计入其他类别
2. 人物行     → startswith("人物：")          → 跳过，不计入任何统计
3. 舞台指示行 → startswith("▲") 或 startswith("【") → stage += 1
4. VO/OS 行   → startswith("VO") 或含 "VO：" 或含 "OS" → stage += 1, vo_os += 1
5. 台词行     → 含全角冒号 "："              → dialogue += 1
6. 其他行     → 不计入台词或舞台指示（计入 total_lines）
```

> 优先级很重要：一行如果同时满足多个条件（比如场次行也含冒号），以先匹配到的为准。

## 7. 扩展指南：接入新样例

### 7.1 步骤

1. **准备 DOCX**：确保格式符合要求（`第N集` 标题 + 标准场次行 + 全角冒号台词）
2. **放入 scripts/**：将文件放到项目 `scripts/` 目录
3. **运行 profile 命令**：

```bash
python -m juben_gen profile
```

4. **检查输出**：查看 `style_profile.json` 的 `sources` 是否包含新样例
5. **审查 target**：融合后的 suggest 值会自动更新，确认是否合理
6. **必要时调整 range**：如果新题材特征差异大，可能需要扩宽 range

### 7.2 新样例的质量要求

- 至少 10 集以上，数据量太少统计偏差大
- 格式必须符合标准（见上述行分类逻辑），否则统计会失准
- 建议同题材至少 2 套样例交叉验证

### 7.3 题材差异处理

不同题材的指标差异可能很大：

| 题材 | 台词偏多 | 镜头偏多 | 场景数 |
|------|---------|---------|--------|
| 宫斗/情感 | 高 | 低 | 少 |
| 动作/悬疑 | 低 | 高 | 多 |
| 末世/生存 | 均衡 | 均衡 | 中 |

**建议**：每个题材维护独立的 style_profile，不要把差异极大的题材混合融合。后续 task05 会实现题材分层模板体系。

## 8. 约束注入流程

统计数据最终通过 `constraints.py` 与格式规范、节奏规则融合：

```
style_profile.json (数值指标)
    +
docs/规则文档.docx (节奏/钩子/模板)
    ↓
constraints.py → build_constraints()
    ↓
constraints.fused.json + STYLE_GUIDE.fused.md
    ↓
prompts.py → 注入到各角色的 system prompt
```

这确保每次生成都携带量化约束，而不是依赖模型「自由发挥」。
