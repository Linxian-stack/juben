# 剧本格式规范

> 覆盖文本格式、DOCX 导出规范和校验规则，可直接作为 AI prompt 约束和程序化校验的依据。

---

## 1. 文本格式规范

### 1.1 集标题

```
第{ep}集
```

- `{ep}` 为阿拉伯数字（如 `第1集`、`第10集`）
- 独占一行，前后无多余空格
- 正则匹配：`^第(\d+)集$`

### 1.2 场次行

```
{ep}-{scene}场  {place}\t{day_or_night}\t{in_or_out}
```

- `{ep}-{scene}`：集号-场号，如 `1-1`、`3-2`
- `{place}`：场景地点，如 `废弃超市`、`王府大殿`
- `{day_or_night}`：`日` 或 `夜`
- `{in_or_out}`：`内` 或 `外`
- 字段间用 Tab 或多个空格分隔，字段顺序固定
- 正则匹配：`^\d+-\d+场\s+.+\s+(日|夜)\s+(内|外)$`
- 每集 1-3 个场景（建议 1.7 个）

**示例**：
```
1-1场  废弃超市	日	内
3-2场  王府花园	夜	外
```

### 1.3 人物行

```
人物：{角色A}、{角色B}、{角色C}
```

- 以 `人物：`（全角冒号）开头
- 角色名之间用顿号 `、` 分隔
- 紧跟在场次行之后，标注该场出场人物
- 不计入行数统计

**示例**：
```
人物：江斐、李燕萍、江子明
```

### 1.4 舞台指示行（动作/镜头）

```
▲{动作描述}
```

- 以 `▲` 开头，后接短句描述动作或镜头
- 每行不超过 2 句，聚焦动作和视觉效果
- 动词优先，写「观众看到什么」而非「发生了什么」
- 每集 8-20 行（建议 14 行）

**示例**：
```
▲江斐眼神一凝，手中尖刀直接向身后劈砍，当一声，尖刀被棍子挡住
▲秦九微用力掐了一把大腿，眸中立刻漫上水色
```

### 1.5 台词行

```
{角色名}：{台词}
```

- 角色名与台词之间用中文全角冒号 `：` 分隔
- 角色名前可带括号表演提示（2-4 字），如 `江斐（冷笑）：做梦！`
- 台词用短句、口语化，禁止书面语
- 每集 10-20 行（建议 10 行）
- 正则匹配：`.+：.+`（含全角冒号的行，且不属于人物行/场次行/舞台指示行）

**示例**：
```
江斐：做梦！
李燕萍（道德绑架）：你妈死得早，这些年全靠我给你养大
```

### 1.6 VO/OS 行

```
VO：{角色名}（画外音内容）
{角色名}OS：{内心独白}
```

- `VO`（Voice Over）：画外音，通常用于旁白或角色不在场时的声音
- `OS`（Off Screen）：画外，角色在场但不在画面中
- VO/OS 归类为舞台指示行的子集
- 每集 0-6 行（建议 4 行）
- 连续 OS 不超过 2 行（避免大段内心独白）
- 匹配规则：以 `VO` 开头，或含 `VO：`，或含 `OS`

### 1.7 转场标记

仅允许以下 4 种标准转场标记：

| 标记 | 用途 |
|------|------|
| `【切】` | 硬切，场景直接切换 |
| `【转】` | 转场过渡 |
| `【闪回】` | 进入闪回段落（必须与 `【闪出】` 配对） |
| `【闪出】` | 退出闪回段落（与 `【闪回】` 配对） |

- 禁止使用 `【淡入】`、`【叠化】` 等非标准标记
- `【闪回】` 和 `【闪出】` 必须成对出现
- 闪回内容不超过 5 行

### 1.8 行分类优先级

同一行可能满足多个条件，按以下优先级从高到低判定：

```
1. 集标题     → 匹配 ^第\d+集$              → 分隔符，不计入任何统计
2. 场次行     → 匹配 ^\d+-\d+              → scenes += 1，不计入其他类别
3. 人物行     → startswith("人物：")         → 跳过，不计入任何统计
4. 舞台指示行 → startswith("▲") 或 startswith("【") → stage += 1
5. VO/OS 行   → startswith("VO") 或含 "VO：" 或含 "OS" → stage += 1, vo_os += 1
6. 台词行     → 含全角冒号 "："             → dialogue += 1
7. 其他行     → 不计入台词或舞台指示（仅计入 total_lines）
```

> 优先级很重要：一行如果同时满足多个条件（比如场次行也含冒号），以先匹配到的为准。

---

## 2. 结构指标约束

基于两套优秀样例（末世天灾 80 集 + 地狱游戏 24 集）的统计融合：

| 指标 | 字段名 | 建议值 | 合理范围 |
|------|--------|--------|----------|
| 场景数/集 | `scenes_per_ep` | 1.7 | [1, 3] |
| 总行数/集 | `total_lines_per_ep` | 28.1 | [22, 38] |
| 台词行/集 | `dialogue_lines_per_ep` | 10.28 | [10, 20] |
| 舞台指示行/集 | `stage_lines_per_ep` | 14.23 | [8, 20] |
| VO/OS行/集 | `vo_os_lines_per_ep` | 4.34 | [0, 6] |

**比例参考**：台词与舞台指示比例约 1:1.4。

---

## 3. 完整集示例

```
第1集

1-1场  废弃超市	日	内
人物：江斐、难民甲、难民乙

▲破败的超市货架东倒西歪，地上散落着空罐头和碎玻璃
▲江斐蹲在角落翻找，手指划破了铁皮边缘，鲜血渗出
江斐（低声）：还有……一定还有
▲身后传来脚步声，三个难民围上来
难民甲：把东西放下！
▲江斐猛地转身，手中尖刀反射出冷光
江斐：想抢？那就来
▲难民甲犹豫了一下，被身后的人推了一把
▲江斐飞刀钉住难民甲的袖口，钉在货架上
难民乙（惊恐）：她疯了！

【切】

1-2场  破旧公寓	夜	内
人物：江斐、李燕萍、江子明

▲江斐推门进来，手里提着一个罐头，衣服上满是血迹
李燕萍（嫌弃）：就带回来这么点东西？
江斐：外面全是人在抢，能拿到就不错了
▲江子明从沙发上起来，盯着罐头舔了下嘴唇
李燕萍：你妈死得早，这些年全靠我给你养大，你就这样报答我？
▲江斐攥紧拳头，指甲陷入掌心
江斐（咬牙）：报答？
▲李燕萍一把抢过罐头，递给江子明
▲江斐腹部突然传来剧痛——江子明手中的刀刺入她的身体
VO：若有来世，我一定要杀了你们
▲江斐倒地，眼前白光一闪——系统提示音响起
▲「吞金超市系统绑定成功」
```

---

## 4. DOCX 导出规范

### 4.1 当前实现

当前 `docx_io.py` 的 `write_docx_lines()` 采用简单导出策略：

| 项目 | 当前设定 |
|------|---------|
| 标题 | `doc.add_heading(title, level=1)` — 作为文档 Heading 1 |
| 正文段落 | `doc.add_paragraph(line)` — 每行一个段落 |
| 空行处理 | 空行输出为空段落 |
| 默认字体/字号 | python-docx 默认（宋体/Calibri, 10.5pt） |
| 行距 | python-docx 默认（单倍行距） |

### 4.2 推荐 DOCX 样式标准

用于正式交付的剧本 DOCX，建议遵循以下样式规范：

| 元素 | 字体 | 字号 | 行距 | 其他 |
|------|------|------|------|------|
| 集标题（`第N集`） | 黑体 | 16pt (小二) | 1.5 倍 | 加粗，段前段后各 12pt |
| 场次行 | 黑体 | 12pt (小四) | 1.25 倍 | 加粗，段前 6pt |
| 人物行 | 宋体 | 10.5pt (五号) | 1.25 倍 | — |
| 舞台指示行（`▲`） | 楷体 | 10.5pt (五号) | 1.25 倍 | 用楷体区分于台词 |
| 台词行 | 宋体 | 10.5pt (五号) | 1.25 倍 | 角色名加粗 |
| VO/OS 行 | 楷体 | 10.5pt (五号) | 1.25 倍 | 斜体 |
| 转场标记 | 黑体 | 10.5pt (五号) | 1.25 倍 | 居中 |

**段落格式**：
- 首行不缩进
- 段落间距：段前 0pt，段后 3pt（紧凑排版）
- 集标题段前 12pt，段后 12pt（视觉分隔）
- 页边距：上下 2.54cm，左右 3.17cm（A4 标准）

> 注：当前 `docx_io.py` 尚未实现上述样式区分，在 task02/task03 阶段可按需增强。

---

## 5. 校验规则描述

以下校验规则供 task04（质量控制）编码实现参考。每条规则包含检查逻辑和严重级别。

### 5.1 格式合规检查

| 编号 | 检查项 | 规则 | 级别 |
|------|--------|------|------|
| F01 | 集标题格式 | 匹配 `^第\d+集$`，每集有且仅有一个 | ERROR |
| F02 | 集号连续性 | 集号从起始值开始连续递增，无跳号 | WARN |
| F03 | 场次行格式 | 匹配 `^\d+-\d+场\s+.+\s+(日\|夜)\s+(内\|外)$` | ERROR |
| F04 | 场次行集号匹配 | 场次行中的集号与所属集标题一致 | ERROR |
| F05 | 人物行格式 | 以 `人物：` 开头，角色名用顿号分隔 | WARN |
| F06 | 台词行格式 | 含全角冒号 `：`，冒号前为角色名（非空） | WARN |
| F07 | 舞台指示格式 | 以 `▲` 开头 | WARN |
| F08 | 转场标记合法性 | 仅包含 `【切】【转】【闪回】【闪出】` | ERROR |
| F09 | 闪回配对 | `【闪回】` 和 `【闪出】` 成对出现 | ERROR |
| F10 | 全角冒号一致性 | 台词行使用全角冒号 `：` 而非半角 `:` | WARN |

### 5.2 行数范围检查

| 编号 | 检查项 | 合理范围 | 级别 |
|------|--------|----------|------|
| L01 | 每集总行数 | [22, 38] | ERROR |
| L02 | 每集台词行数 | [10, 20] | WARN |
| L03 | 每集舞台指示行数 | [8, 20] | WARN |
| L04 | 每集 VO/OS 行数 | [0, 6] | WARN |
| L05 | 每集场景数 | [1, 3] | WARN |

### 5.3 比例检查

| 编号 | 检查项 | 规则 | 级别 |
|------|--------|------|------|
| R01 | 台词/舞台指示比例 | 台词行数 / 舞台指示行数 在 [0.4, 2.0] 范围内 | WARN |
| R02 | 连续 OS 行数 | 连续 OS/VO 行不超过 2 行 | WARN |
| R03 | 闪回长度 | 单次闪回内容不超过 5 行 | WARN |
| R04 | 空集检测 | 每集至少有 1 个场景和 1 行台词 | ERROR |

### 5.4 校验结果格式

建议校验器输出结构化结果：

```json
{
  "file": "剧本名.txt",
  "episodes_checked": 10,
  "errors": [
    {"episode": 3, "rule": "F03", "message": "场次行格式不符: '3-1 客厅 白天 室内'", "line": 45}
  ],
  "warnings": [
    {"episode": 5, "rule": "L02", "message": "台词行数 8 低于下限 10", "line": null}
  ],
  "summary": {
    "total_errors": 1,
    "total_warnings": 1,
    "pass": false
  }
}
```

- `pass` 判定：0 个 ERROR 时为 `true`
- WARN 不阻断，但记录供审稿参考
- 每条 error/warning 尽量携带行号，方便定位
